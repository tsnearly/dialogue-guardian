name: Create Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        default: false
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bump2version build
    
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Bump version
      id: bump
      run: |
        cd dialogue-guardian
        # Create .bumpversion.cfg if it doesn't exist
        if [ ! -f .bumpversion.cfg ]; then
          cat > .bumpversion.cfg << EOF
        [bumpversion]
        current_version = 1.1.0
        commit = True
        tag = True
        tag_name = v{new_version}
        
        [bumpversion:file:setup.py]
        search = version="{current_version}"
        replace = version="{new_version}"
        
        [bumpversion:file:pyproject.toml]
        search = version = "{current_version}"
        replace = version = "{new_version}"
        
        [bumpversion:file:src/guardian/__init__.py]
        search = __version__ = "{current_version}"
        replace = __version__ = "{new_version}"
        EOF
        fi
        
        # Bump version
        bump2version ${{ github.event.inputs.version_type }}
        
        # Get the new version
        NEW_VERSION=$(grep "current_version" .bumpversion.cfg | cut -d' ' -f3)
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "::set-output name=version::$NEW_VERSION"
    
    - name: Build package
      run: |
        cd dialogue-guardian
        python -m build
    
    - name: Generate changelog
      run: |
        cd dialogue-guardian
        # Simple changelog generation
        echo "## Version ${{ env.NEW_VERSION }}" > CHANGELOG_ENTRY.md
        echo "" >> CHANGELOG_ENTRY.md
        echo "### Changes" >> CHANGELOG_ENTRY.md
        git log --oneline --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> CHANGELOG_ENTRY.md || echo "- Initial release" >> CHANGELOG_ENTRY.md
    
    - name: Push changes
      run: |
        git push origin main --tags
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.NEW_VERSION }}
        release_name: Release v${{ env.NEW_VERSION }}
        body_path: dialogue-guardian/CHANGELOG_ENTRY.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease }}